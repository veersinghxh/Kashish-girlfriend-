<!DOCTYPE html>
<html lang="hi">
  <body>
    <button id="startBtn">ЁЯОЩя╕П Start Speech</button>
    <div id="responseBox" style="margin-top:20px; font-size:18px; color:#333;"></div>

    <script>
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const synth = window.speechSynthesis;
      const responseBox = document.getElementById("responseBox");

      let isSpeaking = false; // To prevent overlap
      let keepListening = false; // Loop control

      if (!SpeechRecognition) {
        alert("SpeechRecognition not supported in this browser");
      } else {
        const r = new SpeechRecognition();
        r.continuous = false; // one sentence at a time
        r.interimResults = false;
        r.maxAlternatives = 1;
        r.lang = "hi-IN"; // Hindi language

        // When listening starts
        r.onstart = () => {
          console.log("ЁЯОд Listening...");
          responseBox.innerHTML = "ЁЯОд рд╕реБрди рд░рд╣рд╛ рд╣реВрдБ...";
        };

        // When speech detected
        r.onresult = async function (event) {
          const transcript = event.results[0][0].transcript.trim();
          console.log("You said:", transcript);
          responseBox.innerHTML = `<b>рдЖрдкрдиреЗ рдХрд╣рд╛:</b> ${transcript}<br><br>тП│ рд╕реЛрдЪ рд░рд╣рд╛ рд╣реВрдБ...`;

          const result = await genimi(transcript);

          // Display response
          responseBox.innerHTML = `
            <b>рдЖрдкрдиреЗ рдХрд╣рд╛:</b> ${transcript}<br><br>
            <b>тЭдя╕П рдЧрд░реНрд▓рдлреНрд░реЗрдВрдб рдиреЗ рдХрд╣рд╛:</b> ${result}
          `;

          // Speak and then start listening again
          await speakHindi(result);
          if (keepListening) r.start();
        };

        // If thereтАЩs an error (no sound, etc.)
        r.onerror = (e) => {
          console.warn("Recognition error:", e.error);
          if (keepListening && e.error !== "no-speech") r.start();
        };

        // When recognition ends, restart if looping
        r.onend = () => {
          if (!isSpeaking && keepListening) {
            setTimeout(() => r.start(), 500);
          }
        };

        // Start button
        document.getElementById("startBtn").onclick = () => {
          if (!keepListening) {
            keepListening = true;
            r.start();
            responseBox.innerHTML = "ЁЯОд рд╢реБрд░реВ рдХрд░ рджрд┐рдпрд╛, рдмреЛрд▓рд┐рдП...";
          } else {
            keepListening = false;
            r.stop();
            responseBox.innerHTML = "тП╣я╕П рдмрд╛рддрдЪреАрдд рд░реЛрдХреА рдЧрдИред";
          }
        };
      }

      // Gemini API function
      async function genimi(text) {
        const body = {
          system_instruction: {
            parts: [
              {
                text:
                  "You are an AI Girlfriend of Piyush Garg who likes coding. " +
                  "Respond in Hindi with emotion, using short friendly lines."
              }
            ]
          },
          contents: [{ parts: [{ text }] }]
        };

        const api_key = "AIzaSyBqvPoEO9WXB1_jZxP1lHdoz-uR0iPgz54";

        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${api_key}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body)
            }
          );
          const data = await response.json();
          return (
            data.candidates?.[0]?.content?.parts?.[0]?.text ||
            "тЪая╕П рдХреЛрдИ рдЬрд╡рд╛рдм рдирд╣реАрдВ рдорд┐рд▓рд╛ред"
          );
        } catch (error) {
          console.error("Gemini API Error:", error);
          return "тЭМ Gemini API рд╕реЗ рдХрдиреЗрдХреНрд╢рди рдлреЗрд▓ рд╣реБрдЖред";
        }
      }

      // Speak Hindi (TTS)
      function speakHindi(text) {
        return new Promise((resolve) => {
          if (!synth) {
            alert("Speech Synthesis not supported in this browser.");
            return resolve();
          }

          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = "hi-IN";
          utter.rate = 1;
          utter.pitch = 1;
          utter.volume = 1;

          const voices = synth.getVoices();
          const hindiVoice = voices.find(v => v.lang === "hi-IN") || voices[0];
          if (hindiVoice) utter.voice = hindiVoice;

          isSpeaking = true;
          utter.onend = () => {
            isSpeaking = false;
            resolve();
          };

          synth.cancel(); // stop overlapping
          synth.speak(utter);
        });
      }

      // Load voices
      window.speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();

      // ЁЯФЗ Trick to remove GoogleтАЩs тАЬdingтАЭ sound
      // (use silent mic warm-up тАФ starts/stops once before actual conversation)
      window.addEventListener("load", () => {
        if (SpeechRecognition) {
          const warmup = new SpeechRecognition();
          warmup.start();
          warmup.onend = () => warmup.abort();
        }
      });
    </script>
  </body>
</html>